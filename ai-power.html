<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>AI Power</title>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background-color: #05070b;
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    }

    .page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .header {
      height: 44px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      flex-shrink: 0;
    }

    .header-left {
      width: 40px;
      display: flex;
      align-items: center;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }

    .back-icon {
      width: 10px;
      height: 10px;
      border-left: 2px solid #ffffff;
      border-bottom: 2px solid #ffffff;
      transform: rotate(45deg);
    }

    .header-title {
      flex: 1;
      text-align: center;
      font-size: 16px;
      font-weight: 500;
    }

    .header-right {
      width: 40px;
    }

    .main {
      flex: 1;
      padding: 10px 10px 70px;
      overflow-y: auto;
    }

    .hero-card {
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .hero-card img {
      width: 100%;
      display: block;
    }

    .notice-bar {
      margin-bottom: 12px;
      padding: 6px 10px;
      border-radius: 10px;
      background-color: #05070b;
      border: 1px solid rgba(0, 209, 255, 0.25);
      font-size: 12px;
      display: flex;
      align-items: center;
      color: rgba(255, 255, 255, 0.85);
    }

    .notice-icon {
      margin-right: 6px;
      font-size: 14px;
    }

    .notice-highlight {
      color: #00d1ff;
    }

    .card {
      border-radius: 12px;
      background-color: #101b20;
      padding: 10px 12px;
      margin-bottom: 10px;
    }

    .card-row {
      display: flex;
      gap: 10px;
    }

    .card.half {
      flex: 1;
    }

    .card-title {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.75);
      margin-bottom: 6px;
    }

    .card-main-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-value {
      font-size: 16px;
      font-weight: 500;
    }

    .card-sub {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 4px;
    }

    .btn-gradient {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      outline: none;
      background-image: linear-gradient(90deg, #00d1ff, #46EEAC);
      color: #05070b;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }

    .btn-outline {
      padding: 5px 10px;
      border-radius: 999px;
      background: transparent;
      border: 1px solid #00d1ff;
      color: #00d1ff;
      font-size: 12px;
    }

    .experience-card {
      display: flex;
      align-items: center;
      border-radius: 12px;
      padding: 10px;
      background: radial-gradient(circle at 0% 0%, #1e3d5a, #101b20);
      margin-bottom: 12px;
    }

    .experience-icon {
      width: 40px;
      height: 40px;
      margin-right: 10px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .experience-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .experience-body {
      flex: 1;
    }

    .experience-label {
      font-size: 12px;
      margin-bottom: 4px;
      color: rgba(255, 255, 255, 0.9);
    }

    .experience-slider-track {
      position: relative;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 6px;
    }

    .experience-slider-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 35%;
      border-radius: 999px;
      background-image: linear-gradient(90deg, #00d1ff, #46EEAC);
    }

    .experience-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: rgba(0, 209, 255, 0.15);
      border: 1px solid #00d1ff;
      font-size: 10px;
      color: #00d1ff;
    }

    .section-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      margin-top: 4px;
    }

    .section-underline {
      width: 80px;
      height: 2px;
      border-radius: 999px;
      background-color: #00d1ff;
      margin-bottom: 8px;
    }

    .gpu-card {
      border-radius: 12px;
      background-color: #101b20;
      padding: 10px 10px 12px;
      margin-bottom: 12px;
    }

    .gpu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .gpu-title {
      font-weight: 500;
    }

    .gpu-lock {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background-color: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      gap: 4px;
      color: rgba(255, 255, 255, 0.8);
    }

    .gpu-lock-icon {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.7);
      position: relative;
    }

    .gpu-lock-icon::before {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: 2px;
      border: 1px solid rgba(255, 255, 255, 0.7);
    }

    .gpu-hero {
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .gpu-hero img {
      width: 100%;
      display: block;
    }

    .gpu-stats {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 8px;
    }

    .gpu-col {
      flex: 1;
    }

    .gpu-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .gpu-label {
      color: rgba(255, 255, 255, 0.65);
    }

    .gpu-value {
      color: #ffffff;
      font-weight: 500;
    }

    .gpu-value-accent {
      color: #00d1ff;
    }

    .gpu-button-wrap {
      margin-bottom: 6px;
    }

    .gpu-footnote {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.4;
    }

    .tabbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 60px;
      background-color: #05070b;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      display: none !important;
      justify-content: space-around;
      align-items: center;
      font-size: 10px;
    }

    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      color: rgba(255, 255, 255, 0.6);
    }

    .tab-icon-circle {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      margin-bottom: 2px;
    }

    .tab-icon-circle-big {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      margin-bottom: 2px;
      background-image: radial-gradient(circle at 30% 0%, #00d1ff, #02243f);
    }

    .tab-label {
      white-space: nowrap;
    }

    .tab-item.active {
      color: #00d1ff;
    }
  
    .run-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .run-modal {
      background-color: #101b20;
      border-radius: 16px;
      padding: 18px 20px;
      max-width: 280px;
      width: 80%;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      text-align: center;
    }
    .run-modal-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    .run-modal-text {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.75);
      margin-bottom: 12px;
    }
    .run-modal-spinner {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid rgba(0, 209, 255, 0.25);
      border-top-color: #00d1ff;
      margin: 0 auto 4px;
      animation: run-spin 0.8s linear infinite;
    }
    .run-modal-countdown {
      font-size: 11px;
      color: #00d1ff;
    }
    @keyframes run-spin {
      to {
        transform: rotate(360deg);
      }
    }

  </style>
</head>
<body>
<div class="page">
<div class="header">
<div class="header-left">
<a aria-label="Back" class="back-btn" href="javascript:history.back();">
<span class="back-icon"></span>
</a>
</div>
<div class="header-title">AI Power</div>
<div class="header-right"></div>
</div>
<div class="main">
<div class="hero-card">
<img alt="AI Power Banner" src="images/787b12ff77bd17a97faab26980e3becd.png"/>
</div>
<div class="notice-bar">
<span class="notice-icon">ðŸ”Š</span>
<span class="notice-highlight">337USDT</span>Â rewardsÂ  81***146 invite friends to recharge
      </div>
<div class="card">
<div class="card-title">Amount that can be run today</div>
<div class="card-main-row">
<div class="card-value">0</div>
<button class="btn-gradient">Run record</button>
</div>
</div>
<div class="card-row">
<div class="card half">
<div class="card-title">Number of times that can be run today</div>
<div class="card-main-row">
<div>
<div class="card-value">0 Times</div>
</div>
</div>
<div class="card-sub">
<button class="btn-outline">Earnings Records</button>
</div>
</div>
<div class="card half">
<div class="card-title">Run room</div>
<div class="card-main-row">
<div class="card-value">Â </div>
</div>
<div class="card-sub">
<button class="btn-outline">FAQ</button>
</div>
</div>
</div>
<div class="experience-card">
<div class="experience-icon">
<img alt="Experience" src="images/9aaaf1df80f64963da5fe5b27a7c66ee.png"/>
</div>
<div class="experience-body">
<div class="experience-label">Experience user</div>
<div class="experience-slider-track">
<div class="experience-slider-fill"></div>
</div>
<span class="experience-tag">Level:V0</span>
</div>
</div>
<div class="section-title">Computing power list</div>
<div class="section-underline"></div>
<!-- GPU 2 cores -->
<div class="gpu-card">
<div class="gpu-header">
<div class="gpu-title">GPU 2 cores</div>
<div class="gpu-lock">
<span class="gpu-lock-icon"></span>
<span>Not unlocked</span>
</div>
</div>
<div class="gpu-hero">
<img alt="GPU 2 cores" src="images/6863886ea5961a438f26ea24b647a3b1.png"/>
</div>
<div class="gpu-stats">
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Today's profit</span>
<span class="gpu-value gpu-value-accent">0 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running amount</span>
<span class="gpu-value">300â€“5000 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily run times</span>
<span class="gpu-value">0/2</span>
</div>
</div>
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Level</span>
<span class="gpu-value">V1</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily rate of return</span>
<span class="gpu-value">1.5% ~ 2.8%</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running time</span>
<span class="gpu-value">8 seconds</span>
</div>
</div>
</div>
<div class="gpu-button-wrap">
<button class="btn-gradient">Run after unlocking</button>
</div>
<div class="gpu-footnote">
          *The computing power package needs to be clicked and run for 8 seconds every day to obtain income. If it is not clicked, no income can be obtained on that day. After the operation is completed, the income will be distributed to the account balance.
        </div>
</div>
<!-- GPU 4 cores -->
<div class="gpu-card">
<div class="gpu-header">
<div class="gpu-title">GPU 4 cores</div>
<div class="gpu-lock">
<span class="gpu-lock-icon"></span>
<span>Not unlocked</span>
</div>
</div>
<div class="gpu-hero">
<img alt="GPU 4 cores" src="images/63502635d6b1300b130c966bc2ae5760.png"/>
</div>
<div class="gpu-stats">
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Today's profit</span>
<span class="gpu-value gpu-value-accent">0 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running amount</span>
<span class="gpu-value">500â€“20000 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily run times</span>
<span class="gpu-value">0/3</span>
</div>
</div>
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Level</span>
<span class="gpu-value">V2</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily rate of return</span>
<span class="gpu-value">2% ~ 3.3%</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running time</span>
<span class="gpu-value">8 seconds</span>
</div>
</div>
</div>
<div class="gpu-button-wrap">
<button class="btn-gradient">Run after unlocking</button>
</div>
<div class="gpu-footnote">
          *The computing power package needs to be clicked and run for 8 seconds every day to obtain income. If it is not clicked, no income can be obtained on that day. After the operation is completed, the income will be distributed to the account balance.
        </div>
</div>
<!-- GPU 8 cores -->
<div class="gpu-card">
<div class="gpu-header">
<div class="gpu-title">GPU 8 cores</div>
<div class="gpu-lock">
<span class="gpu-lock-icon"></span>
<span>Not unlocked</span>
</div>
</div>
<div class="gpu-hero">
<img alt="GPU 8 cores" src="images/a7c3b7e3c719242996d00e2094077f62.png"/>
</div>
<div class="gpu-stats">
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Today's profit</span>
<span class="gpu-value gpu-value-accent">0 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running amount</span>
<span class="gpu-value">3000â€“50000 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily run times</span>
<span class="gpu-value">0/5</span>
</div>
</div>
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Level</span>
<span class="gpu-value">V3</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily rate of return</span>
<span class="gpu-value">2.5% ~ 3.8%</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running time</span>
<span class="gpu-value">8 seconds</span>
</div>
</div>
</div>
<div class="gpu-button-wrap">
<button class="btn-gradient">Run after unlocking</button>
</div>
<div class="gpu-footnote">
          *The computing power package needs to be clicked and run for 8 seconds every day to obtain income. If it is not clicked, no income can be obtained on that day. After the operation is completed, the income will be distributed to the account balance.
        </div>
</div>
<!-- GPU 16 cores -->
<div class="gpu-card">
<div class="gpu-header">
<div class="gpu-title">GPU 16 cores</div>
<div class="gpu-lock">
<span class="gpu-lock-icon"></span>
<span>Not unlocked</span>
</div>
</div>
<div class="gpu-hero">
<img alt="GPU 16 cores" src="images/c7ed95180c9cbc57ce1a5e874e0fe691.png"/>
</div>
<div class="gpu-stats">
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Today's profit</span>
<span class="gpu-value gpu-value-accent">0 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running amount</span>
<span class="gpu-value">10000â€“80000 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily run times</span>
<span class="gpu-value">0/5</span>
</div>
</div>
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Level</span>
<span class="gpu-value">V4</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily rate of return</span>
<span class="gpu-value">3% ~ 4.3%</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running time</span>
<span class="gpu-value">8 seconds</span>
</div>
</div>
</div>
<div class="gpu-button-wrap">
<button class="btn-gradient">Run after unlocking</button>
</div>
<div class="gpu-footnote">
          *The computing power package needs to be clicked and run for 8 seconds every day to obtain income. If it is not clicked, no income can be obtained on that day. After the operation is completed, the income will be distributed to the account balance.
        </div>
</div>
<!-- GPU 32 cores -->
<div class="gpu-card">
<div class="gpu-header">
<div class="gpu-title">GPU 32 cores</div>
<div class="gpu-lock">
<span class="gpu-lock-icon"></span>
<span>Not unlocked</span>
</div>
</div>
<div class="gpu-hero">
<img alt="GPU 32 cores" src="images/f01160ae38fd581f12e9c5bb67c9f5a8.png"/>
</div>
<div class="gpu-stats">
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Today's profit</span>
<span class="gpu-value gpu-value-accent">0 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running amount</span>
<span class="gpu-value">30000â€“200000 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily run times</span>
<span class="gpu-value">0/6</span>
</div>
</div>
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Level</span>
<span class="gpu-value">V5</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily rate of return</span>
<span class="gpu-value">3.5% ~ 4.8%</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running time</span>
<span class="gpu-value">8 seconds</span>
</div>
</div>
</div>
<div class="gpu-button-wrap">
<button class="btn-gradient">Run after unlocking</button>
</div>
<div class="gpu-footnote">
          *The computing power package needs to be clicked and run for 8 seconds every day to obtain income. If it is not clicked, no income can be obtained on that day. After the operation is completed, the income will be distributed to the account balance.
        </div>
</div>
<!-- GPU 64 cores -->
<div class="gpu-card">
<div class="gpu-header">
<div class="gpu-title">GPU 64 cores</div>
<div class="gpu-lock">
<span class="gpu-lock-icon"></span>
<span>Not unlocked</span>
</div>
</div>
<div class="gpu-hero">
<img alt="GPU 64 cores" src="images/a33936aa353cbbfd6c6e273ba75db0cb.png"/>
</div>
<div class="gpu-stats">
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Today's profit</span>
<span class="gpu-value gpu-value-accent">0 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running amount</span>
<span class="gpu-value">100000â€“999999 USDT</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily run times</span>
<span class="gpu-value">0/7</span>
</div>
</div>
<div class="gpu-col">
<div class="gpu-row">
<span class="gpu-label">Level</span>
<span class="gpu-value">V6</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Daily rate of return</span>
<span class="gpu-value">4% ~ 5.3%</span>
</div>
<div class="gpu-row">
<span class="gpu-label">Running time</span>
<span class="gpu-value">8 seconds</span>
</div>
</div>
</div>
<div class="gpu-button-wrap">
<button class="btn-gradient">Run after unlocking</button>
</div>
<div class="gpu-footnote">
          *The computing power package needs to be clicked and run for 8 seconds every day to obtain income. If it is not clicked, no income can be obtained on that day. After the operation is completed, the income will be distributed to the account balance.
        </div>
</div>
</div>
</div>

<div class="run-modal-backdrop" id="runModal">
  <div class="run-modal">
    <div class="run-modal-title">Running taskâ€¦</div>
    <div class="run-modal-text">Please wait while your AI power task is running.</div>
    <div class="run-modal-spinner"></div>
    <div class="run-modal-countdown" id="runModalCountdown">8s</div>
  </div>
</div>

<div class="tabbar">
<div class="tab-item">
<div class="tab-icon-circle"></div>
<div class="tab-label">AIâ€“Tools</div>
</div>
<div class="tab-item">
<div class="tab-icon-circle"></div>
<div class="tab-label">AI Chat</div>
</div>
<div class="tab-item active">
<div class="tab-icon-circle-big"></div>
<div class="tab-label">AI Power</div>
</div>
<div class="tab-item">
<div class="tab-icon-circle"></div>
<div class="tab-label">Assets</div>
</div>
<div class="tab-item">
<div class="tab-icon-circle"></div>
<div class="tab-label">Mine</div>
</div>
</div>

<!-- Load Supabase configuration -->
<script src="sb-config.js"></script>
<!-- Authentication helpers -->
<script src="auth.js"></script>
<!-- Wallet helpers -->
<script src="wallet.js"></script>

<script>
;(function () {
  "use strict";

  var SB = window.SB_CONFIG;
  if (!SB) {
    console.error("SB_CONFIG missing (sb-config.js not loaded)");
    return;
  }

  function rpc(name, body) {
    return fetch(SB.url + "/rest/v1/rpc/" + name, {
      method: "POST",
      headers: SB.headers(),
      body: JSON.stringify(body || {})
    }).then(async function (res) {
      var txt = await res.text();
      if (!res.ok) {
        // Supabase often returns plain text or JSON error
        try {
          var j = JSON.parse(txt);
          throw new Error(j.message || j.error || txt || ("RPC " + name + " failed"));
        } catch (e) {
          throw new Error(txt || ("RPC " + name + " failed"));
        }
      }
      try { return JSON.parse(txt); } catch (e) { return txt; }
    });
  }

  function getUserId() {
    if (!window.ExaAuth || typeof window.ExaAuth.ensureSupabaseUserId !== "function") {
      return Promise.resolve("");
    }
    return window.ExaAuth.ensureSupabaseUserId().then(function (uid) { return uid || ""; });
  }

  function levelRank(lvl) {
    var map = { V0:0, V1:1, V2:2, V3:3, V4:4, V5:5, V6:6 };
    return map[(lvl || "").toUpperCase()] ?? 0;
  }

  function fetchUserState(userId) {
    var url = SB.url + "/rest/v1/user_state?select=current_level,is_locked,locked_reason,is_funded,is_activated&user_id=eq." +
      encodeURIComponent(userId) + "&limit=1";
    return fetch(url, { method: "GET", headers: SB.headers() }).then(function (res) {
      if (!res.ok) return [];
      return res.json();
    }).then(function (rows) {
      return (Array.isArray(rows) && rows[0]) ? rows[0] : null;
    });
  }

  function setText(el, text) {
    if (!el) return;
    el.textContent = text;
  }

  function formatUSDT(x) {
    var n = Number(x || 0);
    if (!isFinite(n)) n = 0;
    return n.toFixed(2) + " USDT";
  }

  // --- UI handles ---
  var topCard = document.querySelector(".card");
  var topAmountEl = topCard ? topCard.querySelector(".card-value") : null;

  var cardRowValues = document.querySelectorAll(".card-row .card-value");
  var timesCardValueEl = cardRowValues && cardRowValues[0] ? cardRowValues[0] : null;
  var runRoomValueEl  = cardRowValues && cardRowValues[1] ? cardRowValues[1] : null;

  var levelTagEl = document.querySelector(".experience-tag");

  var modal = document.getElementById("runModal");
  var countdownEl = document.getElementById("runModalCountdown");

  // GPU cards
  var cards = Array.from(document.querySelectorAll(".gpu-card"));
  function getCardLevel(cardEl) {
    // second column -> first row -> value contains V1/V2/...
    var el = cardEl.querySelector(".gpu-col:nth-child(2) .gpu-row:nth-child(1) .gpu-value");
    return (el ? el.textContent : "").trim() || "V0";
  }
  function getLockTextEl(cardEl) {
    return cardEl.querySelector(".gpu-lock span:last-child");
  }
  function getTodayProfitEl(cardEl) {
    return cardEl.querySelector(".gpu-value-accent");
  }
  function getRunTimesEl(cardEl) {
    // first column -> 3rd row -> value is 0/2 ...
    return cardEl.querySelector(".gpu-col:nth-child(1) .gpu-row:nth-child(3) .gpu-value");
  }
  function getRunBtn(cardEl) {
    return cardEl.querySelector(".gpu-button-wrap .btn-gradient");
  }

  function showModal(seconds) {
    if (!modal || !countdownEl) return function(){};
    modal.style.display = "flex";
    countdownEl.textContent = seconds + "s";
    return function hide() { modal.style.display = "none"; };
  }

  function runWithCountdown(seconds, onFinish) {
    seconds = seconds || 8;
    var hide = showModal(seconds);
    var remaining = seconds;

    return new Promise(function (resolve, reject) {
      var timer = setInterval(function () {
        remaining -= 1;
        if (countdownEl) countdownEl.textContent = (remaining >= 0 ? remaining : 0) + "s";
        if (remaining < 0) {
          clearInterval(timer);
          try { hide(); } catch(e){}
          Promise.resolve().then(onFinish).then(resolve).catch(reject);
        }
      }, 1000);
    });
  }

  function refreshTopSummary(userId) {
    return rpc("get_assets_summary", { p_user: userId }).then(function (rows) {
      var s = Array.isArray(rows) ? rows[0] : rows;
      if (!s) return;
      // Top card shows total assets
      setText(topAmountEl, formatUSDT(s.usdt_balance));
      // Cosmetic cards: show remaining times as "â€”" and room as current level
      setText(timesCardValueEl, "â€”");
      setText(runRoomValueEl, (currentLevel || "V0"));
      // Update today's profit on unlocked cards (use today's personal income)
      cards.forEach(function (c) {
        var profEl = getTodayProfitEl(c);
        if (profEl) profEl.textContent = formatUSDT(s.today_personal);
      });
    }).catch(function () {});
  }

  var currentLevel = "V0";
  var currentRank = 0;
  var locked = false;
  var lockReason = "";

  function bindCards(userId) {
    cards.forEach(function (cardEl) {
      var lvl = getCardLevel(cardEl);
      var reqRank = levelRank(lvl);

      var lockTextEl = getLockTextEl(cardEl);
      var btn = getRunBtn(cardEl);
      var runTimesEl = getRunTimesEl(cardEl);

      // Only V1â€“V3 are usable in your backend rules; keep others locked cosmetically.
      var isUsableLevel = reqRank >= 1 && reqRank <= 3;

      var unlocked = (!locked) && isUsableLevel && (currentRank >= reqRank);

      if (lockTextEl) lockTextEl.textContent = unlocked ? "Unlocked" : "Not unlocked";
      if (btn) btn.textContent = unlocked ? "Run" : "Run after unlocking";
      if (runTimesEl) runTimesEl.textContent = "â€”";

      if (!btn) return;

      btn.addEventListener("click", function () {
        if (locked) {
          alert(lockReason || "Account is locked.");
          return;
        }
        if (!unlocked) {
          alert("This computing power package is locked. Please upgrade your member level to use it.");
          return;
        }

        btn.disabled = true;
        runWithCountdown(8, function () {
          return rpc("perform_ipower_action", { p_user: userId });
        }).then(function (rows) {
          var r = Array.isArray(rows) ? rows[0] : rows;
          // r has earning_amount & new_balance in your SQL
          var earned = r && (r.earning_amount ?? r.earning_amount === 0 ? r.earning_amount : null);
          var newBal = r && (r.new_balance ?? null);

          // Update UI quickly
          if (newBal != null) setText(topAmountEl, formatUSDT(newBal));
          if (earned != null) {
            var profEl = getTodayProfitEl(cardEl);
            if (profEl) profEl.textContent = formatUSDT(earned); // shows last run earning (safe)
            alert("Run completed. Profit +" + Number(earned).toFixed(2) + " USDT");
          } else {
            alert("Run completed.");
          }

          // Refresh totals (today/total/team) via summary
          return refreshTopSummary(userId);
        }).catch(function (err) {
          var msg = (err && err.message) ? err.message : String(err || "Run failed");
          // Make backend errors readable
          alert(msg);
        }).finally(function () {
          btn.disabled = false;
        });
      });
    });
  }

  // Init
  getUserId().then(function (userId) {
    if (!userId) {
      alert("Please login first.");
      window.location.href = "login.html";
      return;
    }

    return fetchUserState(userId).then(function (st) {
      currentLevel = (st && st.current_level) ? String(st.current_level).toUpperCase() : "V0";
      currentRank = levelRank(currentLevel);
      locked = !!(st && st.is_locked);
      lockReason = (st && st.locked_reason) ? String(st.locked_reason) : "";

      if (levelTagEl) levelTagEl.textContent = "Level:" + currentLevel;
      setText(runRoomValueEl, currentLevel);

      bindCards(userId);
      return refreshTopSummary(userId);
    });
  }).catch(function (e) {
    console.error(e);
  });

})();
</script>

<!-- Enforce login redirects -->
<script src="common-nav.js"></script>
</body>
</html>
